# Инструкция по запуску HyperSniper Indexer

## Репозиторий

GitHub: https://github.com/srobex/TGTON2Index

## Требования

- Go 1.23+
- Docker 24+ и docker-compose
- PostgreSQL 16 (используется в docker-compose)
- Redis 7+
- Telegram Bot API токен и chat_id (канал/чат)

## Установка на VPS (Ubuntu/Debian)

### 1. Обновление системы

```bash
sudo apt update && sudo apt upgrade -y
```

### 2. Установка Docker

```bash
# Установка Docker
curl -fsSL https://get.docker.com | sh

# Добавляем пользователя в группу docker
sudo usermod -aG docker $USER

# Устанавливаем docker-compose плагин
sudo apt install docker-compose-plugin -y

# Применяем изменения группы (или перезайти в систему)
newgrp docker
```

### 3. Установка Git (если нет)

```bash
sudo apt install git -y
```

### 4. Клонирование репозитория

```bash
git clone https://github.com/srobex/TGTON2Index.git
cd TGTON2Index
```

### 5. (Опционально) Установка Go для локального запуска

```bash
wget https://go.dev/dl/go1.23.4.linux-amd64.tar.gz
sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf go1.23.4.linux-amd64.tar.gz
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
source ~/.bashrc
go version
```

## Конфигурация

1. Отредактируйте `config.yaml`:

```bash
nano config.yaml
```

Заполните:
   - `app.network`: `mainnet` (по умолчанию) или `testnet`
   - `notifier.tg_bot_token`: токен бота от @BotFather
   - `notifier.tg_chat_id`: ID канала/чата для уведомлений
   - `notifier.webhook_url`: (опционально)

2. Переменные окружения перекрывают YAML (префикс `HSI_`, точки заменены на `_`), например:
   - `HSI_APP_NETWORK=testnet`
   - `HSI_REDIS_ADDR=redis:6379`
   - `HSI_POSTGRES_DSN=postgres://...`

## Запуск через Docker Compose (рекомендуется)

```bash
cd docker
docker-compose up --build -d
```

Флаг `-d` запускает в фоновом режиме.

Сервисы: `postgres`, `redis`, `app`. Конфиг монтируется в контейнер `app` по пути `/config/config.yaml`.

### Полезные команды

```bash
# Смотреть логи в реальном времени
docker-compose logs -f app

# Перезапустить приложение
docker-compose restart app

# Остановить всё
docker-compose down

# Остановить и удалить данные (осторожно!)
docker-compose down -v
```

## Локальный запуск (без Docker)

Требуется установленный Go и запущенные PostgreSQL + Redis.

```bash
go run ./cmd/indexer --network=mainnet
```

Для testnet:

```bash
go run ./cmd/indexer --network=testnet
```

## Проверка работы

### 1. Проверить что контейнеры запущены

```bash
docker ps
```

Должны быть 3 контейнера: `postgres`, `redis`, `app`.

### 2. Смотреть логи

```bash
cd docker
docker-compose logs -f app
```

При первом запуске будет синхронизация блокчейна — это нормально.

### 3. Тест на testnet

1. Поменяйте в `config.yaml`: `network: "testnet"`
2. Перезапустите: `docker-compose restart app`
3. Создайте тестовый JettonMinter в testnet
4. Сообщение должно появиться в консоли и Telegram

### 4. Проверка задержки

Когда придёт уведомление о новом токене:
1. Запомните время из уведомления
2. Откройте `https://tonviewer.com/<адрес_токена>`
3. Сравните время создания — разница должна быть 1-2 секунды

## Переключение на выделенный liteserver

- Добавьте адреса в `app.liteservers_list` или пробросьте через env `HSI_APP_LITESERVERS_LIST` (JSON-массив в строке).
- Перезапустите сервис.

## Graceful shutdown

- Приложение завершает работу по `SIGINT/SIGTERM` и корректно закрывает соединения.

## Обновление на VPS

```bash
cd TGTON2Index
git pull
cd docker
docker-compose up --build -d
```

## Что ещё

- Prometheus endpoint не включён по умолчанию (будет добавлен отдельным шагом).
- Все комментарии в коде — на русском, имена функций/переменных — на английском.
